---
title: "STRETCH - Northern Latitudes Draft MS Figures"
subtitle: "`r Sys.Date()` <br> D Briscoe"
author: ""
date: ""
format:
  html:
    theme: flatly
    fontsize: 20px
    toc: true
    toc-expand: true	
    number-sections: false
    toc-location: left
    number-depth: 2
    smooth-scroll: true
    fig-cap-location: top
    scrollable: true
filters:
  - lightbox
lightbox: 
  match: auto
  effect: zoom
  desc-position: top
---


```{=html}
<style>
.main-container {
    max-width: 1600px !important;
    margin-left: 0;
    margin-right: 1;
}

#quarto-document-content {
  width: 950px;
}

</style>

<style type="text/css">
  body{
  font-size: 12.5pt;
}

h1, .title, .subtitle {
    <!-- font-family: Arial, sans-serif; -->
    <!-- font-weight: 700; -->
    color: black;
}

h2, h3 {
  color: #447099;
  font-weight: 500;
}

</style>

```

```{r 00-setup, include=FALSE}
knitr::opts_chunk$set(
    echo = FALSE,
    eval = TRUE,
    message = FALSE,
    warning = FALSE,
    dpi = 300#,
    # fig.align = "center"
    )

# See Options: knitr::opts_chunk$get()
```


<br>


### Fig 1 \| Average Turtle Latitude by Week

<br>

[Main figure is shown in the first tab: **July-Sept**]{style="font-size: 15pt"} 

<br>

[Second figure is fyi to show how 2023 turtles are closing the gap and are now tracking much closer to historic lats since mid-Oct/Nov]{style="font-size: 15pt"}

<br>

::: {.panel-tabset}
#### July-Sept
![](images/draft_fig1_plot_avg_turtle_lats_by_week_july_sept.png)

#### July-Nov (extra)
![](images/draft_fig1_plot_avg_turtle_lats_by_week_july_nov.png)
:::

<br>

### Table \| SCL (cm)

<br>

[SCL Size Distribution ('Historic' 1997 - 2012 vs 'Cohort 1' (2023)]{style="font-size: 18pt"}


{{< include 08_northern_lats_cc_env_histograms.qmd >}}

<br>


<!-- ### Fig 2 \| Turtle-Env Histograms -->

<!-- <br> -->

<!-- [September & March SSTs for Historic (1997 - 2012) vs 'Cohort 1' (2023)]{style="font-size: 18pt"} -->

<!-- <br> -->


### Fig 3 \| September Turtle & 18°C Isotherm Position

<br>
[Mean Lat/Long for Multi-year September Turtles]{style="font-size: 18pt"}

<br>

::: columns
::: {.column width="5%"}
[text]{style="color:transparent"}
:::

::: {.column width="95%"}
<span style="font-size:16pt">
Average SST Isotherm Location:<br>
[**2006 - 2007 18°C (light purple)**]{style="color:#9D4EDD"} <br>
[**19.5°C (dark purple)**]{style="color:#3C096C"} <br>
[**2023 18°C (light green)**]{style="color:#69b3a2"} <br>
[**2023 19.5°C (dark green)**]{style="color:#2D6D5E"}

</span>
:::
:::

![](images/draft_fig3_plot_avg_cc_and_18C_195C_isotherms_sept_by_enso.png)
<br>

[Mean Lat/Long for '1st September' Turtles]{style="font-size: 18pt"}

<br>

::: columns
::: {.column width="5%"}
[text]{style="color:transparent"}
:::

::: {.column width="95%"}
<span style="font-size:16pt">
Average SST Isotherm Location:<br>
[**2005 18°C (light purple, n=31)**]{style="color:#9D4EDD"} <br>
[**2023 18°C (light green, n=24)**]{style="color:#69b3a2"} <br>

</span>
:::
:::


![](images/draft_fig3_alt_plot_avg_cc_and_18C_1st_septs_isotherms_sept.png)


<br>

[Sept & March Mean Lat/Long for Turtles (1997-2012, 2023)]{style="font-size: 18pt"}

<br>

::: columns
::: {.column width="5%"}
[text]{style="color:transparent"}
:::

::: {.column width="95%"}
<span style="font-size:16pt">
Average Turtle Location between 178°W and 140°W:<br>
[**March 1997 - 2012 (blue)**]{style="color:#0077B6"} <br>
[**September 1997 - 2012 (red)**]{style="color:#9e2a2b"} <br>
[**September 2023 (green)**]{style="color:#69b3a2"} <br>

</span>
:::
:::

<br>

![](images/draft_fig3_alt_plot_avg_cc_1997_2012_2023.png)

<br>


### Fig 4 \| September & March GAMs

<br>

### **18°C Isotherm GAMs**

```{r 07-05rmd-load-grouped-by-year-month-rds}

# fyi, need to load this df from '04 rmd'
grouped_by_year_month <- readRDS("../data/interim/04_grouped_by_year_month_Jan1981_Oct2023.rds")

```

```{r 07-05rmd-get-sum-stats-lat-year-sept-mar}
# calc average lat of the 18deg C isotherm (165W-140W)
mean_18deg_lat_by_year <- grouped_by_year_month %>%
    group_by(year, x, month, day, month_abb) %>%
        # filter(month == 9) %>%
    filter(z >= 18 & z < 18.1) %>%
    summarise(y = mean(y, na.rm=T),
              z = mean(z, na.rm=T)) %>%
    relocate(year, .after=x) %>%
    relocate(y, .before=x) %>%
    relocate(z, .after=x) %>%
    mutate(mean_18degC_lat = y) %>%
    ungroup() %>%
    mutate(., c.month = row_number())

```


```{r 07-gam-libraries}
library(mgcv)
library(gratia)
```

[**Model: March Latitude of 18°C isotherm \~ Year**]{style="font-size: 16pt"}

```{r 07-gam-yr-mar}

model_mar = gam(y~s(year, k=7, fx=T), #+s(month,bs="cc",k=12.5),
                       data=mean_18deg_lat_by_year %>% filter(month == 3))
```

::: {.panel-tabset}

#### Partial Plot
```{r}
df <- mean_18deg_lat_by_year %>% filter(month == 3)

pd <- with(df, data.frame(year = seq(min(year),max(year),1)))
pd <- cbind(pd, predict(model_mar, pd, se = TRUE))
pd <- transform(pd, upr = fit + (2*se.fit), lwr = fit - (2*se.fit))

ggplot(pd, aes(x = year, y = fit)) +
    geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.2) +
    geom_point(data = df, aes(year, y), col = 'dodgerblue') +
    geom_line(alpha = 0.5) + 
    labs(x = "Year", y = "Latitude (°N)")
```


#### GAM Summary
```{r}
summary(model_mar)
```

#### GAM Check
```{r}
gam.check(model_mar, rep=100)

```
<!-- ![March](images/gam_partial_plot_Mar_18C.png) -->
:::


<br>

[**Model: September Latitude of 18°C isotherm \~ Year**]{style="font-size: 16pt"}

<!-- ![Sept](images/gam_partial_plot_Sept_18C.png) -->
```{r 07-gam-yr-sept}
model_sept = gam(y~s(year, k=9, fx=T), #+s(month,bs="cc",k=12.5),
                       data=mean_18deg_lat_by_year %>% filter(month == 9))
```

::: {.panel-tabset}

#### Partial Plot
```{r}
df <- mean_18deg_lat_by_year %>% filter(month == 9)

pd <- with(df, data.frame(year = seq(min(year),max(year),1)))
pd <- cbind(pd, predict(model_sept, pd, se = TRUE))
pd <- transform(pd, upr = fit + (2*se.fit), lwr = fit - (2*se.fit))

ggplot(pd, aes(x = year, y = fit)) +
    geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.2) +
    geom_point(data = df, aes(year, y), col = 'dodgerblue') +
    geom_line(alpha = 0.5) + 
    labs(x = "Year", y = "Latitude (°N)")
```


#### GAM Summary
```{r}
summary(model_sept)
```

#### GAM Check
```{r}
gam.check(model_sept, rep=100)

```
<!-- ![March](images/gam_partial_plot_Mar_18C.png) -->
:::



[Difference September - Mar 18°C Isotherm Position (165°W - 140°W)]{style="font-size: 16pt"}

```{r 07-05-gam-18degC-lat-year-output-diff-sept-mar}

mean_18deg_lat_by_year_sept_only <- mean_18deg_lat_by_year %>% filter(month == 9)
mean_18deg_lat_by_year_mar_only <- mean_18deg_lat_by_year %>% filter(month == 3)

mean_18deg_lat_by_year_diff_sept_mar <- 
    mean_18deg_lat_by_year %>% filter(month == 9 | month == 3) %>%
    ungroup() %>%
    dplyr::select(c("year", "month_abb", "mean_18degC_lat")) %>%
    # filter(year > 1997) %>% # fyi, there is no march '97, so remove full year
    spread(month_abb,mean_18degC_lat) %>%
    mutate(y = Sep - Mar)

```

```{r}
mean_18deg_lat_by_year_diff_sept_mar %>%
ggplot(., aes(year, y)) +
    geom_point(fill = "steelblue", colour = "steelblue", alpha = 0.6, size=2) +
    # geom_line(colour = "steelblue", alpha = 0.9, lwd =1) +
    # geom_smooth(method = "loess", colour = "black") +
    geom_smooth(span = 0.3) +
    theme(axis.title.x = element_blank(),
          legend.position = "none") +
    scale_x_continuous(breaks=seq(1985,2023,2)) + 
    labs(x = 'Year', y = 'Difference Between Sept - Mar 18°C (°Latitude)',
         caption = 'Loess smoother') 
```

<br>


### **Turtle GAMs**


{{< include 09b_northern_lats_cc_gams.qmd >}}


### Fig 5 \| Longterm Seasonal 18°C Isotherm Position

<br>

::: columns
::: {.column width="8%"}
[text]{style="color:transparent"}
:::

::: {.column width="92%"}
<span style="font-size:14pt">
**Black Line: 2020 - 2023 Average** <br>
[**Light Gray Line: 1990 - 1993 Average**]{style="color:#ADB5BD"} <br>
</span>
:::
:::

![](images/draft_fig5_plot_18C_isotherm_longterm_sept_mar.png)




## Additional Figures 

### Fig | Average Seasonal Position of 18°C (March/Sept) between 1985 - 2023

<br>


<br>

![](images/plot_mar_sept_avg_lats_no_turtles_18C.png)
<br>
<br>

### Fig | Monthly 18C SST Isotherm Position by ENSO Year

<br>

![](images/plot_tzcf_enso_yrs.png)

<br>
<br>

### Fig | Annual SST Anomaly & 18°C Isotherm Position in the NE Pacific, by ENSO 

<br>

[Location of 18°C isotherm based on the September preceding an ENSO event <br> (ie Sept 1997 = 'El Nino' Sept)  *-- or-- * year of a marine heatwave (MHW, ie Sept 2015 = 'MHW')]{style="font-size: 16pt"}

<span style="font-size:16pt">
ENSO episodes were assigned using NOAA's
[ONI Nino 3.4 ](https://origin.cpc.ncep.noaa.gov/products/analysis_monitoring/ensostuff/ONI_v5.php)
</span>

<br>

<span style="font-size:16pt">
For each of the figures below: <br>
**Black line: A given year's 18°C SST isotherm location** <br>
[**Gray line: The longterm 18°C SST isotherm (1985-2023) location**]{style="color:#6C757D"} <br>
The **black box is the spatial boundary (165°W to 140°W)** used to delineate the NE Pacific study area
</span>

<br>
<br>


![El Nino (Septembers Preceding an El Nino Epsisode)](images/plot_sept_ssta_yrs_with_sst_18C_pre_el_nino.png)

![La Nina (Septembers Preceding a La Nina Episode)](images/plot_sept_ssta_yrs_with_sst_18C_pre_la_nina.png)

![Neutral (Septembers Preceding a Neutral Episode)](images/plot_sept_ssta_yrs_with_sst_18C_pre_neutral.png)

![Marine Heatwave Septembers](images/plot_sept_ssta_yrs_with_sst_18C_mhw.png)